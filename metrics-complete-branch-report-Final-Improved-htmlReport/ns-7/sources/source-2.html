


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > InstrumentedEhcache</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.codahale.metrics.ehcache</a>
</div>

<h1>Coverage Summary for Class: InstrumentedEhcache (com.codahale.metrics.ehcache)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">InstrumentedEhcache</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    87.5%
  </span>
  <span class="absValue">
    (21/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    78%
  </span>
  <span class="absValue">
    (46/59)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.codahale.metrics.ehcache;
&nbsp;
&nbsp;import com.codahale.metrics.MetricRegistry;
&nbsp;import com.codahale.metrics.Timer;
&nbsp;import net.sf.ehcache.CacheException;
&nbsp;import net.sf.ehcache.Ehcache;
&nbsp;import net.sf.ehcache.Element;
&nbsp;import net.sf.ehcache.constructs.EhcacheDecoratorAdapter;
&nbsp;import net.sf.ehcache.statistics.StatisticsGateway;
&nbsp;
&nbsp;import java.io.Serializable;
&nbsp;
&nbsp;import static com.codahale.metrics.MetricRegistry.name;
&nbsp;
&nbsp;/**
&nbsp; * An instrumented {@link Ehcache} instance.
&nbsp; */
&nbsp;public class InstrumentedEhcache extends EhcacheDecoratorAdapter {
&nbsp;    /**
&nbsp;     * Instruments the given {@link Ehcache} instance with get and put timers
&nbsp;     * and a set of gauges for Ehcache&#39;s built-in statistics:
&nbsp;     * &lt;p&gt;
&nbsp;     * &lt;table&gt;
&nbsp;     * &lt;caption&gt;Ehcache timered metrics&lt;/caption&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code hits}&lt;/td&gt;
&nbsp;     * &lt;td&gt;The number of times a requested item was found in the
&nbsp;     * cache.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code in-memory-hits}&lt;/td&gt;
&nbsp;     * &lt;td&gt;Number of times a requested item was found in the memory
&nbsp;     * store.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code off-heap-hits}&lt;/td&gt;
&nbsp;     * &lt;td&gt;Number of times a requested item was found in the off-heap
&nbsp;     * store.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code on-disk-hits}&lt;/td&gt;
&nbsp;     * &lt;td&gt;Number of times a requested item was found in the disk
&nbsp;     * store.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code misses}&lt;/td&gt;
&nbsp;     * &lt;td&gt;Number of times a requested item was not found in the
&nbsp;     * cache.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code in-memory-misses}&lt;/td&gt;
&nbsp;     * &lt;td&gt;Number of times a requested item was not found in the memory
&nbsp;     * store.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code off-heap-misses}&lt;/td&gt;
&nbsp;     * &lt;td&gt;Number of times a requested item was not found in the
&nbsp;     * off-heap store.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code on-disk-misses}&lt;/td&gt;
&nbsp;     * &lt;td&gt;Number of times a requested item was not found in the disk
&nbsp;     * store.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code objects}&lt;/td&gt;
&nbsp;     * &lt;td&gt;Number of elements stored in the cache.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code in-memory-objects}&lt;/td&gt;
&nbsp;     * &lt;td&gt;Number of objects in the memory store.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code off-heap-objects}&lt;/td&gt;
&nbsp;     * &lt;td&gt;Number of objects in the off-heap store.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code on-disk-objects}&lt;/td&gt;
&nbsp;     * &lt;td&gt;Number of objects in the disk store.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code mean-get-time}&lt;/td&gt;
&nbsp;     * &lt;td&gt;The average get time. Because ehcache support JDK1.4.2, each
&nbsp;     * get time uses {@link System#currentTimeMillis()}, rather than
&nbsp;     * nanoseconds. The accuracy is thus limited.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code mean-search-time}&lt;/td&gt;
&nbsp;     * &lt;td&gt;The average execution time (in milliseconds) within the last
&nbsp;     * sample period.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code eviction-count}&lt;/td&gt;
&nbsp;     * &lt;td&gt;The number of cache evictions, since the cache was created,
&nbsp;     * or statistics were cleared.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code searches-per-second}&lt;/td&gt;
&nbsp;     * &lt;td&gt;The number of search executions that have completed in the
&nbsp;     * last second.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;tr&gt;
&nbsp;     * &lt;td&gt;{@code accuracy}&lt;/td&gt;
&nbsp;     * &lt;td&gt;A human readable description of the accuracy setting. One of
&nbsp;     * &quot;None&quot;, &quot;Best Effort&quot; or &quot;Guaranteed&quot;.&lt;/td&gt;
&nbsp;     * &lt;/tr&gt;
&nbsp;     * &lt;/table&gt;
&nbsp;     * &lt;p&gt;
&nbsp;     * &lt;b&gt;N.B.: This enables Ehcache&#39;s sampling statistics with an accuracy
&nbsp;     * level of &quot;none.&quot;&lt;/b&gt;
&nbsp;     *
&nbsp;     * @param cache    an {@link Ehcache} instance
&nbsp;     * @param registry a {@link MetricRegistry}
&nbsp;     * @return an instrumented decorator for {@code cache}
&nbsp;     * @see StatisticsGateway
&nbsp;     */
&nbsp;    public static Ehcache instrument(MetricRegistry registry, final Ehcache cache) {
&nbsp;
<b class="fc">&nbsp;        final String prefix = name(cache.getClass(), cache.getName());</b>
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;hits&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().cacheHitCount());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;in-memory-hits&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().localHeapHitCount());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;off-heap-hits&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().localOffHeapHitCount());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;on-disk-hits&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().localDiskHitCount());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;misses&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().cacheMissCount());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;in-memory-misses&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().localHeapMissCount());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;off-heap-misses&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().localOffHeapMissCount());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;on-disk-misses&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().localDiskMissCount());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;objects&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().getSize());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;in-memory-objects&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().getLocalHeapSize());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;off-heap-objects&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().getLocalOffHeapSize());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;on-disk-objects&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().getLocalDiskSize());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;mean-get-time&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().cacheGetOperation().latency().average().value());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;mean-search-time&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().cacheSearchOperation().latency().average().value());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;eviction-count&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().cacheEvictionOperation().count().value());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;searches-per-second&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().cacheSearchOperation().rate().value());</b>
&nbsp;
<b class="fc">&nbsp;        registry.registerGauge(name(prefix, &quot;writer-queue-size&quot;),</b>
<b class="fc">&nbsp;                () -&gt; cache.getStatistics().getWriterQueueLength());</b>
&nbsp;
<b class="fc">&nbsp;        return new InstrumentedEhcache(registry, cache);</b>
&nbsp;    }
&nbsp;
&nbsp;    private final Timer getTimer, putTimer;
&nbsp;
&nbsp;    private InstrumentedEhcache(MetricRegistry registry, Ehcache cache) {
<b class="fc">&nbsp;        super(cache);</b>
<b class="fc">&nbsp;        this.getTimer = registry.timer(name(cache.getClass(), cache.getName(), &quot;gets&quot;));</b>
<b class="fc">&nbsp;        this.putTimer = registry.timer(name(cache.getClass(), cache.getName(), &quot;puts&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Element get(Object key) throws IllegalStateException, CacheException {
<b class="nc">&nbsp;        final Timer.Context ctx = getTimer.time();</b>
&nbsp;        try {
<b class="nc">&nbsp;            return underlyingCache.get(key);</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            ctx.stop();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Element get(Serializable key) throws IllegalStateException, CacheException {
<b class="fc">&nbsp;        final Timer.Context ctx = getTimer.time();</b>
&nbsp;        try {
<b class="fc">&nbsp;            return underlyingCache.get(key);</b>
&nbsp;        } finally {
<b class="fc">&nbsp;            ctx.stop();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void put(Element element) throws IllegalArgumentException, IllegalStateException, CacheException {
<b class="fc">&nbsp;        final Timer.Context ctx = putTimer.time();</b>
&nbsp;        try {
<b class="fc">&nbsp;            underlyingCache.put(element);</b>
&nbsp;        } finally {
<b class="fc">&nbsp;            ctx.stop();</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void put(Element element, boolean doNotNotifyCacheReplicators) throws IllegalArgumentException, IllegalStateException, CacheException {
<b class="nc">&nbsp;        final Timer.Context ctx = putTimer.time();</b>
&nbsp;        try {
<b class="nc">&nbsp;            underlyingCache.put(element, doNotNotifyCacheReplicators);</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            ctx.stop();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Element putIfAbsent(Element element) throws NullPointerException {
<b class="nc">&nbsp;        final Timer.Context ctx = putTimer.time();</b>
&nbsp;        try {
<b class="nc">&nbsp;            return underlyingCache.putIfAbsent(element);</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            ctx.stop();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-01 18:42</div>
</div>
</body>
</html>
