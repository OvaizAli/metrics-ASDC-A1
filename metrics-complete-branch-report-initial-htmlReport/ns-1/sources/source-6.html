


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > CsvReporter</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.codahale.metrics</a>
</div>

<h1>Coverage Summary for Class: CsvReporter (com.codahale.metrics)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CsvReporter</td>
<td class="coverageStat">
  <span class="percent">
    91.7%
  </span>
  <span class="absValue">
    (11/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    88%
  </span>
  <span class="absValue">
    (81/92)
  </span>
</td>
</tr>
  <tr>
    <td class="name">CsvReporter$1</td>
  </tr>
  <tr>
    <td class="name">CsvReporter$Builder</td>
<td class="coverageStat">
  <span class="percent">
    83.3%
  </span>
  <span class="absValue">
    (10/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    84.4%
  </span>
  <span class="absValue">
    (27/32)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    87.5%
  </span>
  <span class="absValue">
    (21/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    87.1%
  </span>
  <span class="absValue">
    (108/124)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.codahale.metrics;
&nbsp;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;import java.io.File;
&nbsp;import java.io.FileOutputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.io.OutputStreamWriter;
&nbsp;import java.io.PrintWriter;
&nbsp;import java.util.Locale;
&nbsp;import java.util.Map;
&nbsp;import java.util.SortedMap;
&nbsp;import java.util.concurrent.ScheduledExecutorService;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;
&nbsp;import static java.nio.charset.StandardCharsets.UTF_8;
&nbsp;
&nbsp;/**
&nbsp; * A reporter which creates a comma-separated values file of the measurements for each metric.
&nbsp; */
<b class="fc">&nbsp;public class CsvReporter extends ScheduledReporter {</b>
&nbsp;    private static final String DEFAULT_SEPARATOR = &quot;,&quot;;
&nbsp;
&nbsp;    /**
&nbsp;     * Returns a new {@link Builder} for {@link CsvReporter}.
&nbsp;     *
&nbsp;     * @param registry the registry to report
&nbsp;     * @return a {@link Builder} instance for a {@link CsvReporter}
&nbsp;     */
&nbsp;    public static Builder forRegistry(MetricRegistry registry) {
<b class="fc">&nbsp;        return new Builder(registry);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * A builder for {@link CsvReporter} instances. Defaults to using the default locale, converting
&nbsp;     * rates to events/second, converting durations to milliseconds, and not filtering metrics.
&nbsp;     */
<b class="fc">&nbsp;    public static class Builder {</b>
&nbsp;        private final MetricRegistry registry;
&nbsp;        private Locale locale;
&nbsp;        private String separator;
&nbsp;        private TimeUnit rateUnit;
&nbsp;        private TimeUnit durationUnit;
&nbsp;        private Clock clock;
&nbsp;        private MetricFilter filter;
&nbsp;        private ScheduledExecutorService executor;
&nbsp;        private boolean shutdownExecutorOnStop;
&nbsp;        private CsvFileProvider csvFileProvider;
&nbsp;
<b class="fc">&nbsp;        private Builder(MetricRegistry registry) {</b>
<b class="fc">&nbsp;            this.registry = registry;</b>
<b class="fc">&nbsp;            this.locale = Locale.getDefault();</b>
<b class="fc">&nbsp;            this.separator = DEFAULT_SEPARATOR;</b>
<b class="fc">&nbsp;            this.rateUnit = TimeUnit.SECONDS;</b>
<b class="fc">&nbsp;            this.durationUnit = TimeUnit.MILLISECONDS;</b>
<b class="fc">&nbsp;            this.clock = Clock.defaultClock();</b>
<b class="fc">&nbsp;            this.filter = MetricFilter.ALL;</b>
<b class="fc">&nbsp;            this.executor = null;</b>
<b class="fc">&nbsp;            this.shutdownExecutorOnStop = true;</b>
<b class="fc">&nbsp;            this.csvFileProvider = new FixedNameCsvFileProvider();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        /**
&nbsp;         * Specifies whether or not, the executor (used for reporting) will be stopped with same time with reporter.
&nbsp;         * Default value is true.
&nbsp;         * Setting this parameter to false, has the sense in combining with providing external managed executor via {@link #scheduleOn(ScheduledExecutorService)}.
&nbsp;         *
&nbsp;         * @param shutdownExecutorOnStop if true, then executor will be stopped in same time with this reporter
&nbsp;         * @return {@code this}
&nbsp;         */
&nbsp;        public Builder shutdownExecutorOnStop(boolean shutdownExecutorOnStop) {
<b class="nc">&nbsp;            this.shutdownExecutorOnStop = shutdownExecutorOnStop;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Specifies the executor to use while scheduling reporting of metrics.
&nbsp;         * Default value is null.
&nbsp;         * Null value leads to executor will be auto created on start.
&nbsp;         *
&nbsp;         * @param executor the executor to use while scheduling reporting of metrics.
&nbsp;         * @return {@code this}
&nbsp;         */
&nbsp;        public Builder scheduleOn(ScheduledExecutorService executor) {
<b class="nc">&nbsp;            this.executor = executor;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Format numbers for the given {@link Locale}.
&nbsp;         *
&nbsp;         * @param locale a {@link Locale}
&nbsp;         * @return {@code this}
&nbsp;         */
&nbsp;        public Builder formatFor(Locale locale) {
<b class="fc">&nbsp;            this.locale = locale;</b>
<b class="fc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Convert rates to the given time unit.
&nbsp;         *
&nbsp;         * @param rateUnit a unit of time
&nbsp;         * @return {@code this}
&nbsp;         */
&nbsp;        public Builder convertRatesTo(TimeUnit rateUnit) {
<b class="fc">&nbsp;            this.rateUnit = rateUnit;</b>
<b class="fc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Convert durations to the given time unit.
&nbsp;         *
&nbsp;         * @param durationUnit a unit of time
&nbsp;         * @return {@code this}
&nbsp;         */
&nbsp;        public Builder convertDurationsTo(TimeUnit durationUnit) {
<b class="fc">&nbsp;            this.durationUnit = durationUnit;</b>
<b class="fc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Use the given string to use as the separator for values.
&nbsp;         *
&nbsp;         * @param separator the string to use for the separator.
&nbsp;         * @return {@code this}
&nbsp;         */
&nbsp;        public Builder withSeparator(String separator) {
<b class="fc">&nbsp;            this.separator = separator;</b>
<b class="fc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Use the given {@link Clock} instance for the time.
&nbsp;         *
&nbsp;         * @param clock a {@link Clock} instance
&nbsp;         * @return {@code this}
&nbsp;         */
&nbsp;        public Builder withClock(Clock clock) {
<b class="fc">&nbsp;            this.clock = clock;</b>
<b class="fc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Only report metrics which match the given filter.
&nbsp;         *
&nbsp;         * @param filter a {@link MetricFilter}
&nbsp;         * @return {@code this}
&nbsp;         */
&nbsp;        public Builder filter(MetricFilter filter) {
<b class="fc">&nbsp;            this.filter = filter;</b>
<b class="fc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public Builder withCsvFileProvider(CsvFileProvider csvFileProvider) {
<b class="fc">&nbsp;            this.csvFileProvider = csvFileProvider;</b>
<b class="fc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Builds a {@link CsvReporter} with the given properties, writing {@code .csv} files to the
&nbsp;         * given directory.
&nbsp;         *
&nbsp;         * @param directory the directory in which the {@code .csv} files will be created
&nbsp;         * @return a {@link CsvReporter}
&nbsp;         */
&nbsp;        public CsvReporter build(File directory) {
<b class="fc">&nbsp;            return new CsvReporter(registry,</b>
&nbsp;                    directory,
&nbsp;                    locale,
&nbsp;                    separator,
&nbsp;                    rateUnit,
&nbsp;                    durationUnit,
&nbsp;                    clock,
&nbsp;                    filter,
&nbsp;                    executor,
&nbsp;                    shutdownExecutorOnStop,
&nbsp;                    csvFileProvider);
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    private static final Logger LOGGER = LoggerFactory.getLogger(CsvReporter.class);</b>
&nbsp;
&nbsp;    private final File directory;
&nbsp;    private final Locale locale;
&nbsp;    private final String separator;
&nbsp;    private final Clock clock;
&nbsp;    private final CsvFileProvider csvFileProvider;
&nbsp;
&nbsp;    private final String histogramFormat;
&nbsp;    private final String meterFormat;
&nbsp;    private final String timerFormat;
&nbsp;
&nbsp;    private final String timerHeader;
&nbsp;    private final String meterHeader;
&nbsp;    private final String histogramHeader;
&nbsp;
&nbsp;    private CsvReporter(MetricRegistry registry,
&nbsp;                        File directory,
&nbsp;                        Locale locale,
&nbsp;                        String separator,
&nbsp;                        TimeUnit rateUnit,
&nbsp;                        TimeUnit durationUnit,
&nbsp;                        Clock clock,
&nbsp;                        MetricFilter filter,
&nbsp;                        ScheduledExecutorService executor,
&nbsp;                        boolean shutdownExecutorOnStop,
&nbsp;                        CsvFileProvider csvFileProvider) {
<b class="fc">&nbsp;        super(registry, &quot;csv-reporter&quot;, filter, rateUnit, durationUnit, executor, shutdownExecutorOnStop);</b>
<b class="fc">&nbsp;        this.directory = directory;</b>
<b class="fc">&nbsp;        this.locale = locale;</b>
<b class="fc">&nbsp;        this.separator = separator;</b>
<b class="fc">&nbsp;        this.clock = clock;</b>
<b class="fc">&nbsp;        this.csvFileProvider = csvFileProvider;</b>
&nbsp;
<b class="fc">&nbsp;        this.histogramFormat = String.join(separator, &quot;%d&quot;, &quot;%d&quot;, &quot;%f&quot;, &quot;%d&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;);</b>
<b class="fc">&nbsp;        this.meterFormat = String.join(separator, &quot;%d&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;events/%s&quot;);</b>
<b class="fc">&nbsp;        this.timerFormat = String.join(separator, &quot;%d&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;%f&quot;, &quot;calls/%s&quot;, &quot;%s&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        this.timerHeader = String.join(separator, &quot;count&quot;, &quot;max&quot;, &quot;mean&quot;, &quot;min&quot;, &quot;stddev&quot;, &quot;p50&quot;, &quot;p75&quot;, &quot;p95&quot;, &quot;p98&quot;, &quot;p99&quot;, &quot;p999&quot;, &quot;mean_rate&quot;, &quot;m1_rate&quot;, &quot;m5_rate&quot;, &quot;m15_rate&quot;, &quot;rate_unit&quot;, &quot;duration_unit&quot;);</b>
<b class="fc">&nbsp;        this.meterHeader = String.join(separator, &quot;count&quot;, &quot;mean_rate&quot;, &quot;m1_rate&quot;, &quot;m5_rate&quot;, &quot;m15_rate&quot;, &quot;rate_unit&quot;);</b>
<b class="fc">&nbsp;        this.histogramHeader = String.join(separator, &quot;count&quot;, &quot;max&quot;, &quot;mean&quot;, &quot;min&quot;, &quot;stddev&quot;, &quot;p50&quot;, &quot;p75&quot;, &quot;p95&quot;, &quot;p98&quot;, &quot;p99&quot;, &quot;p999&quot;);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    @SuppressWarnings(&quot;rawtypes&quot;)
&nbsp;    public void report(SortedMap&lt;String, Gauge&gt; gauges,
&nbsp;                       SortedMap&lt;String, Counter&gt; counters,
&nbsp;                       SortedMap&lt;String, Histogram&gt; histograms,
&nbsp;                       SortedMap&lt;String, Meter&gt; meters,
&nbsp;                       SortedMap&lt;String, Timer&gt; timers) {
<b class="fc">&nbsp;        final long timestamp = TimeUnit.MILLISECONDS.toSeconds(clock.getTime());</b>
&nbsp;
<b class="pc">&nbsp;        for (Map.Entry&lt;String, Gauge&gt; entry : gauges.entrySet()) {</b>
<b class="fc">&nbsp;            reportGauge(timestamp, entry.getKey(), entry.getValue());</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="pc">&nbsp;        for (Map.Entry&lt;String, Counter&gt; entry : counters.entrySet()) {</b>
<b class="fc">&nbsp;            reportCounter(timestamp, entry.getKey(), entry.getValue());</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="pc">&nbsp;        for (Map.Entry&lt;String, Histogram&gt; entry : histograms.entrySet()) {</b>
<b class="fc">&nbsp;            reportHistogram(timestamp, entry.getKey(), entry.getValue());</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="pc">&nbsp;        for (Map.Entry&lt;String, Meter&gt; entry : meters.entrySet()) {</b>
<b class="fc">&nbsp;            reportMeter(timestamp, entry.getKey(), entry.getValue());</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="pc">&nbsp;        for (Map.Entry&lt;String, Timer&gt; entry : timers.entrySet()) {</b>
<b class="fc">&nbsp;            reportTimer(timestamp, entry.getKey(), entry.getValue());</b>
<b class="fc">&nbsp;        }</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private void reportTimer(long timestamp, String name, Timer timer) {
<b class="fc">&nbsp;        final Snapshot snapshot = timer.getSnapshot();</b>
&nbsp;
<b class="fc">&nbsp;        report(timestamp,</b>
&nbsp;                name,
&nbsp;                timerHeader,
&nbsp;                timerFormat,
<b class="fc">&nbsp;                timer.getCount(),</b>
<b class="fc">&nbsp;                convertDuration(snapshot.getMax()),</b>
<b class="fc">&nbsp;                convertDuration(snapshot.getMean()),</b>
<b class="fc">&nbsp;                convertDuration(snapshot.getMin()),</b>
<b class="fc">&nbsp;                convertDuration(snapshot.getStdDev()),</b>
<b class="fc">&nbsp;                convertDuration(snapshot.getMedian()),</b>
<b class="fc">&nbsp;                convertDuration(snapshot.get75thPercentile()),</b>
<b class="fc">&nbsp;                convertDuration(snapshot.get95thPercentile()),</b>
<b class="fc">&nbsp;                convertDuration(snapshot.get98thPercentile()),</b>
<b class="fc">&nbsp;                convertDuration(snapshot.get99thPercentile()),</b>
<b class="fc">&nbsp;                convertDuration(snapshot.get999thPercentile()),</b>
<b class="fc">&nbsp;                convertRate(timer.getMeanRate()),</b>
<b class="fc">&nbsp;                convertRate(timer.getOneMinuteRate()),</b>
<b class="fc">&nbsp;                convertRate(timer.getFiveMinuteRate()),</b>
<b class="fc">&nbsp;                convertRate(timer.getFifteenMinuteRate()),</b>
<b class="fc">&nbsp;                getRateUnit(),</b>
<b class="fc">&nbsp;                getDurationUnit());</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private void reportMeter(long timestamp, String name, Meter meter) {
<b class="fc">&nbsp;        report(timestamp,</b>
&nbsp;                name,
&nbsp;                meterHeader,
&nbsp;                meterFormat,
<b class="fc">&nbsp;                meter.getCount(),</b>
<b class="fc">&nbsp;                convertRate(meter.getMeanRate()),</b>
<b class="fc">&nbsp;                convertRate(meter.getOneMinuteRate()),</b>
<b class="fc">&nbsp;                convertRate(meter.getFiveMinuteRate()),</b>
<b class="fc">&nbsp;                convertRate(meter.getFifteenMinuteRate()),</b>
<b class="fc">&nbsp;                getRateUnit());</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private void reportHistogram(long timestamp, String name, Histogram histogram) {
<b class="fc">&nbsp;        final Snapshot snapshot = histogram.getSnapshot();</b>
&nbsp;
<b class="fc">&nbsp;        report(timestamp,</b>
&nbsp;                name,
&nbsp;                histogramHeader,
&nbsp;                histogramFormat,
<b class="fc">&nbsp;                histogram.getCount(),</b>
<b class="fc">&nbsp;                snapshot.getMax(),</b>
<b class="fc">&nbsp;                snapshot.getMean(),</b>
<b class="fc">&nbsp;                snapshot.getMin(),</b>
<b class="fc">&nbsp;                snapshot.getStdDev(),</b>
<b class="fc">&nbsp;                snapshot.getMedian(),</b>
<b class="fc">&nbsp;                snapshot.get75thPercentile(),</b>
<b class="fc">&nbsp;                snapshot.get95thPercentile(),</b>
<b class="fc">&nbsp;                snapshot.get98thPercentile(),</b>
<b class="fc">&nbsp;                snapshot.get99thPercentile(),</b>
<b class="fc">&nbsp;                snapshot.get999thPercentile());</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private void reportCounter(long timestamp, String name, Counter counter) {
<b class="fc">&nbsp;        report(timestamp, name, &quot;count&quot;, &quot;%d&quot;, counter.getCount());</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private void reportGauge(long timestamp, String name, Gauge&lt;?&gt; gauge) {
<b class="fc">&nbsp;        report(timestamp, name, &quot;value&quot;, &quot;%s&quot;, gauge.getValue());</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private void report(long timestamp, String name, String header, String line, Object... values) {
&nbsp;        try {
<b class="fc">&nbsp;            final File file = csvFileProvider.getFile(directory, name);</b>
<b class="fc">&nbsp;            final boolean fileAlreadyExists = file.exists();</b>
<b class="pc">&nbsp;            if (fileAlreadyExists || file.createNewFile()) {</b>
<b class="fc">&nbsp;                try (PrintWriter out = new PrintWriter(new OutputStreamWriter(</b>
&nbsp;                        new FileOutputStream(file, true), UTF_8))) {
<b class="pc">&nbsp;                    if (!fileAlreadyExists) {</b>
<b class="fc">&nbsp;                        out.println(&quot;t&quot; + separator + header);</b>
&nbsp;                    }
<b class="fc">&nbsp;                    out.printf(locale, String.format(locale, &quot;%d&quot; + separator + &quot;%s%n&quot;, timestamp, line), values);</b>
<b class="fc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            LOGGER.warn(&quot;Error writing to {}&quot;, name, e);</b>
<b class="fc">&nbsp;        }</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    protected String sanitize(String name) {
<b class="nc">&nbsp;        return name;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-02-28 00:31</div>
</div>
</body>
</html>
