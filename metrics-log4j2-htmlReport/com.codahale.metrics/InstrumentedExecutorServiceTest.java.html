<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InstrumentedExecutorServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">All in metrics-log4j2 Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.codahale.metrics</a> &gt; <span class="el_source">InstrumentedExecutorServiceTest.java</span></div><h1>InstrumentedExecutorServiceTest.java</h1><pre class="source lang-java linenums">package com.codahale.metrics;

import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.Duration;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.ForkJoinPool;
import java.util.concurrent.Future;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

import static org.assertj.core.api.Assertions.assertThat;

<span class="nc" id="L21">public class InstrumentedExecutorServiceTest {</span>

<span class="nc" id="L23">    private static final Logger LOGGER = LoggerFactory.getLogger(InstrumentedExecutorServiceTest.class);</span>
    private ExecutorService executor;
    private MetricRegistry registry;
    private InstrumentedExecutorService instrumentedExecutorService;
    private Meter submitted;
    private Counter running;
    private Meter completed;
    private Timer duration;
    private Timer idle;

    @Before
    public void setup() {
<span class="nc" id="L35">        executor = Executors.newCachedThreadPool();</span>
<span class="nc" id="L36">        registry = new MetricRegistry();</span>
<span class="nc" id="L37">        instrumentedExecutorService = new InstrumentedExecutorService(executor, registry, &quot;xs&quot;);</span>
<span class="nc" id="L38">        submitted = registry.meter(&quot;xs.submitted&quot;);</span>
<span class="nc" id="L39">        running = registry.counter(&quot;xs.running&quot;);</span>
<span class="nc" id="L40">        completed = registry.meter(&quot;xs.completed&quot;);</span>
<span class="nc" id="L41">        duration = registry.timer(&quot;xs.duration&quot;);</span>
<span class="nc" id="L42">        idle = registry.timer(&quot;xs.idle&quot;);</span>
<span class="nc" id="L43">    }</span>

    @After
    public void tearDown() throws Exception {
<span class="nc" id="L47">        instrumentedExecutorService.shutdown();</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">        if (!instrumentedExecutorService.awaitTermination(2, TimeUnit.SECONDS)) {</span>
<span class="nc" id="L49">            LOGGER.error(&quot;InstrumentedExecutorService did not terminate.&quot;);</span>
        }
<span class="nc" id="L51">    }</span>

    @Test
    public void reportsTasksInformationForRunnable() throws Exception {

<span class="nc" id="L56">        assertThat(submitted.getCount()).isEqualTo(0);</span>
<span class="nc" id="L57">        assertThat(running.getCount()).isEqualTo(0);</span>
<span class="nc" id="L58">        assertThat(completed.getCount()).isEqualTo(0);</span>
<span class="nc" id="L59">        assertThat(duration.getCount()).isEqualTo(0);</span>
<span class="nc" id="L60">        assertThat(idle.getCount()).isEqualTo(0);</span>

<span class="nc" id="L62">        Runnable runnable = () -&gt; {</span>
<span class="nc" id="L63">            assertThat(submitted.getCount()).isEqualTo(1);</span>
<span class="nc" id="L64">            assertThat(running.getCount()).isEqualTo(1);</span>
<span class="nc" id="L65">            assertThat(completed.getCount()).isEqualTo(0);</span>
<span class="nc" id="L66">            assertThat(duration.getCount()).isEqualTo(0);</span>
<span class="nc" id="L67">            assertThat(idle.getCount()).isEqualTo(1);</span>
<span class="nc" id="L68">        };</span>

<span class="nc" id="L70">        Future&lt;?&gt; theFuture = instrumentedExecutorService.submit(runnable);</span>

<span class="nc" id="L72">        theFuture.get();</span>

<span class="nc" id="L74">        assertThat(submitted.getCount()).isEqualTo(1);</span>
<span class="nc" id="L75">        assertThat(running.getCount()).isEqualTo(0);</span>
<span class="nc" id="L76">        assertThat(completed.getCount()).isEqualTo(1);</span>
<span class="nc" id="L77">        assertThat(duration.getCount()).isEqualTo(1);</span>
<span class="nc" id="L78">        assertThat(duration.getSnapshot().size()).isEqualTo(1);</span>
<span class="nc" id="L79">        assertThat(idle.getCount()).isEqualTo(1);</span>
<span class="nc" id="L80">        assertThat(idle.getSnapshot().size()).isEqualTo(1);</span>
<span class="nc" id="L81">    }</span>

    @Test
    public void reportsTasksInformationForCallable() throws Exception {

<span class="nc" id="L86">        assertThat(submitted.getCount()).isEqualTo(0);</span>
<span class="nc" id="L87">        assertThat(running.getCount()).isEqualTo(0);</span>
<span class="nc" id="L88">        assertThat(completed.getCount()).isEqualTo(0);</span>
<span class="nc" id="L89">        assertThat(duration.getCount()).isEqualTo(0);</span>
<span class="nc" id="L90">        assertThat(idle.getCount()).isEqualTo(0);</span>

<span class="nc" id="L92">        Callable&lt;Void&gt; callable = () -&gt; {</span>
<span class="nc" id="L93">            assertThat(submitted.getCount()).isEqualTo(1);</span>
<span class="nc" id="L94">            assertThat(running.getCount()).isEqualTo(1);</span>
<span class="nc" id="L95">            assertThat(completed.getCount()).isEqualTo(0);</span>
<span class="nc" id="L96">            assertThat(duration.getCount()).isEqualTo(0);</span>
<span class="nc" id="L97">            assertThat(idle.getCount()).isEqualTo(1);</span>
<span class="nc" id="L98">            return null;</span>
        };

<span class="nc" id="L101">        Future&lt;?&gt; theFuture = instrumentedExecutorService.submit(callable);</span>

<span class="nc" id="L103">        theFuture.get();</span>

<span class="nc" id="L105">        assertThat(submitted.getCount()).isEqualTo(1);</span>
<span class="nc" id="L106">        assertThat(running.getCount()).isEqualTo(0);</span>
<span class="nc" id="L107">        assertThat(completed.getCount()).isEqualTo(1);</span>
<span class="nc" id="L108">        assertThat(duration.getCount()).isEqualTo(1);</span>
<span class="nc" id="L109">        assertThat(duration.getSnapshot().size()).isEqualTo(1);</span>
<span class="nc" id="L110">        assertThat(idle.getCount()).isEqualTo(1);</span>
<span class="nc" id="L111">        assertThat(idle.getSnapshot().size()).isEqualTo(1);</span>
<span class="nc" id="L112">    }</span>

    @Test
    @SuppressWarnings(&quot;unchecked&quot;)
    public void reportsTasksInformationForThreadPoolExecutor() throws Exception {
<span class="nc" id="L117">        executor = new ThreadPoolExecutor(4, 16,</span>
                0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;&gt;(32));
<span class="nc" id="L119">        instrumentedExecutorService = new InstrumentedExecutorService(executor, registry, &quot;tp&quot;);</span>
<span class="nc" id="L120">        submitted = registry.meter(&quot;tp.submitted&quot;);</span>
<span class="nc" id="L121">        running = registry.counter(&quot;tp.running&quot;);</span>
<span class="nc" id="L122">        completed = registry.meter(&quot;tp.completed&quot;);</span>
<span class="nc" id="L123">        duration = registry.timer(&quot;tp.duration&quot;);</span>
<span class="nc" id="L124">        idle = registry.timer(&quot;tp.idle&quot;);</span>
<span class="nc" id="L125">        final Gauge&lt;Integer&gt; poolSize = (Gauge&lt;Integer&gt;) registry.getGauges().get(&quot;tp.pool.size&quot;);</span>
<span class="nc" id="L126">        final Gauge&lt;Integer&gt; poolCoreSize = (Gauge&lt;Integer&gt;) registry.getGauges().get(&quot;tp.pool.core&quot;);</span>
<span class="nc" id="L127">        final Gauge&lt;Integer&gt; poolMaxSize = (Gauge&lt;Integer&gt;) registry.getGauges().get(&quot;tp.pool.max&quot;);</span>
<span class="nc" id="L128">        final Gauge&lt;Integer&gt; tasksActive = (Gauge&lt;Integer&gt;) registry.getGauges().get(&quot;tp.tasks.active&quot;);</span>
<span class="nc" id="L129">        final Gauge&lt;Long&gt; tasksCompleted = (Gauge&lt;Long&gt;) registry.getGauges().get(&quot;tp.tasks.completed&quot;);</span>
<span class="nc" id="L130">        final Gauge&lt;Integer&gt; tasksQueued = (Gauge&lt;Integer&gt;) registry.getGauges().get(&quot;tp.tasks.queued&quot;);</span>
<span class="nc" id="L131">        final Gauge&lt;Integer&gt; tasksCapacityRemaining = (Gauge&lt;Integer&gt;) registry.getGauges().get(&quot;tp.tasks.capacity&quot;);</span>

<span class="nc" id="L133">        assertThat(submitted.getCount()).isEqualTo(0);</span>
<span class="nc" id="L134">        assertThat(running.getCount()).isEqualTo(0);</span>
<span class="nc" id="L135">        assertThat(completed.getCount()).isEqualTo(0);</span>
<span class="nc" id="L136">        assertThat(duration.getCount()).isEqualTo(0);</span>
<span class="nc" id="L137">        assertThat(idle.getCount()).isEqualTo(0);</span>
<span class="nc" id="L138">        assertThat(poolSize.getValue()).isEqualTo(0);</span>
<span class="nc" id="L139">        assertThat(poolCoreSize.getValue()).isEqualTo(4);</span>
<span class="nc" id="L140">        assertThat(poolMaxSize.getValue()).isEqualTo(16);</span>
<span class="nc" id="L141">        assertThat(tasksActive.getValue()).isEqualTo(0);</span>
<span class="nc" id="L142">        assertThat(tasksCompleted.getValue()).isEqualTo(0L);</span>
<span class="nc" id="L143">        assertThat(tasksQueued.getValue()).isEqualTo(0);</span>
<span class="nc" id="L144">        assertThat(tasksCapacityRemaining.getValue()).isEqualTo(32);</span>

<span class="nc" id="L146">        Runnable runnable = () -&gt; {</span>
<span class="nc" id="L147">            assertThat(submitted.getCount()).isEqualTo(1);</span>
<span class="nc" id="L148">            assertThat(running.getCount()).isEqualTo(1);</span>
<span class="nc" id="L149">            assertThat(completed.getCount()).isEqualTo(0);</span>
<span class="nc" id="L150">            assertThat(duration.getCount()).isEqualTo(0);</span>
<span class="nc" id="L151">            assertThat(idle.getCount()).isEqualTo(1);</span>
<span class="nc" id="L152">            assertThat(tasksActive.getValue()).isEqualTo(1);</span>
<span class="nc" id="L153">            assertThat(tasksQueued.getValue()).isEqualTo(0);</span>
<span class="nc" id="L154">        };</span>

<span class="nc" id="L156">        Future&lt;?&gt; theFuture = instrumentedExecutorService.submit(runnable);</span>

<span class="nc" id="L158">        assertThat(theFuture).succeedsWithin(Duration.ofSeconds(5L));</span>

<span class="nc" id="L160">        assertThat(submitted.getCount()).isEqualTo(1);</span>
<span class="nc" id="L161">        assertThat(running.getCount()).isEqualTo(0);</span>
<span class="nc" id="L162">        assertThat(completed.getCount()).isEqualTo(1);</span>
<span class="nc" id="L163">        assertThat(duration.getCount()).isEqualTo(1);</span>
<span class="nc" id="L164">        assertThat(duration.getSnapshot().size()).isEqualTo(1);</span>
<span class="nc" id="L165">        assertThat(idle.getCount()).isEqualTo(1);</span>
<span class="nc" id="L166">        assertThat(idle.getSnapshot().size()).isEqualTo(1);</span>
<span class="nc" id="L167">        assertThat(poolSize.getValue()).isEqualTo(1);</span>
<span class="nc" id="L168">    }</span>

    @Test
    @SuppressWarnings(&quot;unchecked&quot;)
    public void reportsTasksInformationForForkJoinPool() throws Exception {
<span class="nc" id="L173">        executor = Executors.newWorkStealingPool(4);</span>
<span class="nc" id="L174">        instrumentedExecutorService = new InstrumentedExecutorService(executor, registry, &quot;fjp&quot;);</span>
<span class="nc" id="L175">        submitted = registry.meter(&quot;fjp.submitted&quot;);</span>
<span class="nc" id="L176">        running = registry.counter(&quot;fjp.running&quot;);</span>
<span class="nc" id="L177">        completed = registry.meter(&quot;fjp.completed&quot;);</span>
<span class="nc" id="L178">        duration = registry.timer(&quot;fjp.duration&quot;);</span>
<span class="nc" id="L179">        idle = registry.timer(&quot;fjp.idle&quot;);</span>
<span class="nc" id="L180">        final Gauge&lt;Long&gt; tasksStolen = (Gauge&lt;Long&gt;) registry.getGauges().get(&quot;fjp.tasks.stolen&quot;);</span>
<span class="nc" id="L181">        final Gauge&lt;Long&gt; tasksQueued = (Gauge&lt;Long&gt;) registry.getGauges().get(&quot;fjp.tasks.queued&quot;);</span>
<span class="nc" id="L182">        final Gauge&lt;Integer&gt; threadsActive = (Gauge&lt;Integer&gt;) registry.getGauges().get(&quot;fjp.threads.active&quot;);</span>
<span class="nc" id="L183">        final Gauge&lt;Integer&gt; threadsRunning = (Gauge&lt;Integer&gt;) registry.getGauges().get(&quot;fjp.threads.running&quot;);</span>

<span class="nc" id="L185">        assertThat(submitted.getCount()).isEqualTo(0);</span>
<span class="nc" id="L186">        assertThat(running.getCount()).isEqualTo(0);</span>
<span class="nc" id="L187">        assertThat(completed.getCount()).isEqualTo(0);</span>
<span class="nc" id="L188">        assertThat(duration.getCount()).isEqualTo(0);</span>
<span class="nc" id="L189">        assertThat(idle.getCount()).isEqualTo(0);</span>
<span class="nc" id="L190">        assertThat(tasksStolen.getValue()).isEqualTo(0L);</span>
<span class="nc" id="L191">        assertThat(tasksQueued.getValue()).isEqualTo(0L);</span>
<span class="nc" id="L192">        assertThat(threadsActive.getValue()).isEqualTo(0);</span>
<span class="nc" id="L193">        assertThat(threadsRunning.getValue()).isEqualTo(0);</span>

<span class="nc" id="L195">        Runnable runnable = () -&gt; {</span>
<span class="nc" id="L196">            assertThat(submitted.getCount()).isEqualTo(1);</span>
<span class="nc" id="L197">            assertThat(running.getCount()).isEqualTo(1);</span>
<span class="nc" id="L198">            assertThat(completed.getCount()).isEqualTo(0);</span>
<span class="nc" id="L199">            assertThat(duration.getCount()).isEqualTo(0);</span>
<span class="nc" id="L200">            assertThat(idle.getCount()).isEqualTo(1);</span>
<span class="nc" id="L201">            assertThat(tasksQueued.getValue()).isEqualTo(0L);</span>
<span class="nc" id="L202">            assertThat(threadsActive.getValue()).isEqualTo(1);</span>
<span class="nc" id="L203">            assertThat(threadsRunning.getValue()).isEqualTo(1);</span>
<span class="nc" id="L204">        };</span>

<span class="nc" id="L206">        Future&lt;?&gt; theFuture = instrumentedExecutorService.submit(runnable);</span>

<span class="nc" id="L208">        assertThat(theFuture).succeedsWithin(Duration.ofSeconds(5L));</span>

<span class="nc" id="L210">        assertThat(submitted.getCount()).isEqualTo(1);</span>
<span class="nc" id="L211">        assertThat(running.getCount()).isEqualTo(0);</span>
<span class="nc" id="L212">        assertThat(completed.getCount()).isEqualTo(1);</span>
<span class="nc" id="L213">        assertThat(duration.getCount()).isEqualTo(1);</span>
<span class="nc" id="L214">        assertThat(duration.getSnapshot().size()).isEqualTo(1);</span>
<span class="nc" id="L215">        assertThat(idle.getCount()).isEqualTo(1);</span>
<span class="nc" id="L216">        assertThat(idle.getSnapshot().size()).isEqualTo(1);</span>
<span class="nc" id="L217">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>