<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WeightedSnapshotTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">All in metrics-log4j2 Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.codahale.metrics</a> &gt; <span class="el_source">WeightedSnapshotTest.java</span></div><h1>WeightedSnapshotTest.java</h1><pre class="source lang-java linenums">package com.codahale.metrics;

import com.codahale.metrics.WeightedSnapshot.WeightedSample;
import org.junit.Test;
import org.mockito.ArgumentMatchers;

import java.io.ByteArrayOutputStream;
import java.util.ArrayList;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.offset;
import static org.mockito.Mockito.doReturn;
import static org.mockito.Mockito.spy;
import static org.mockito.Mockito.when;

<span class="nc" id="L17">public class WeightedSnapshotTest {</span>

    private static List&lt;WeightedSample&gt; weightedArray(long[] values, double[] weights) {
<span class="nc bnc" id="L20" title="All 2 branches missed.">        if (values.length != weights.length) {</span>
<span class="nc" id="L21">            throw new IllegalArgumentException(&quot;Mismatched lengths: &quot; + values.length + &quot; vs &quot; + weights.length);</span>
        }

<span class="nc" id="L24">        final List&lt;WeightedSample&gt; samples = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L25" title="All 2 branches missed.">        for (int i = 0; i &lt; values.length; i++) {</span>
<span class="nc" id="L26">            samples.add(new WeightedSnapshot.WeightedSample(values[i], weights[i]));</span>
        }

<span class="nc" id="L29">        return samples;</span>
    }

<span class="nc" id="L32">    private final Snapshot snapshot = new WeightedSnapshot(</span>
<span class="nc" id="L33">            weightedArray(new long[]{5, 1, 2, 3, 4}, new double[]{1, 2, 3, 2, 2}));</span>

    @Test
    public void smallQuantilesAreTheFirstValue() {
<span class="nc" id="L37">        assertThat(snapshot.getValue(0.0))</span>
<span class="nc" id="L38">                .isEqualTo(1.0, offset(0.1));</span>
<span class="nc" id="L39">    }</span>

    @Test
    public void bigQuantilesAreTheLastValue() {
<span class="nc" id="L43">        assertThat(snapshot.getValue(1.0))</span>
<span class="nc" id="L44">                .isEqualTo(5.0, offset(0.1));</span>
<span class="nc" id="L45">    }</span>

    @Test(expected = IllegalArgumentException.class)
    public void disallowsNotANumberQuantile() {
<span class="nc" id="L49">        snapshot.getValue(Double.NaN);</span>
<span class="nc" id="L50">    }</span>

    @Test(expected = IllegalArgumentException.class)
    public void disallowsNegativeQuantile() {
<span class="nc" id="L54">        snapshot.getValue(-0.5);</span>
<span class="nc" id="L55">    }</span>

    @Test(expected = IllegalArgumentException.class)
    public void disallowsQuantileOverOne() {
<span class="nc" id="L59">        snapshot.getValue(1.5);</span>
<span class="nc" id="L60">    }</span>

    @Test
    public void hasAMedian() {
<span class="nc" id="L64">        assertThat(snapshot.getMedian()).isEqualTo(3.0, offset(0.1));</span>
<span class="nc" id="L65">    }</span>

    @Test
    public void hasAp75() {
<span class="nc" id="L69">        assertThat(snapshot.get75thPercentile()).isEqualTo(4.0, offset(0.1));</span>
<span class="nc" id="L70">    }</span>

    @Test
    public void hasAp95() {
<span class="nc" id="L74">        assertThat(snapshot.get95thPercentile()).isEqualTo(5.0, offset(0.1));</span>
<span class="nc" id="L75">    }</span>

    @Test
    public void hasAp98() {
<span class="nc" id="L79">        assertThat(snapshot.get98thPercentile()).isEqualTo(5.0, offset(0.1));</span>
<span class="nc" id="L80">    }</span>

    @Test
    public void hasAp99() {
<span class="nc" id="L84">        assertThat(snapshot.get99thPercentile()).isEqualTo(5.0, offset(0.1));</span>
<span class="nc" id="L85">    }</span>

    @Test
    public void hasAp999() {
<span class="nc" id="L89">        assertThat(snapshot.get999thPercentile()).isEqualTo(5.0, offset(0.1));</span>
<span class="nc" id="L90">    }</span>

    @Test
    public void hasValues() {
<span class="nc" id="L94">        assertThat(snapshot.getValues())</span>
<span class="nc" id="L95">                .containsOnly(1, 2, 3, 4, 5);</span>
<span class="nc" id="L96">    }</span>

    @Test
    public void hasASize() {
<span class="nc" id="L100">        assertThat(snapshot.size())</span>
<span class="nc" id="L101">                .isEqualTo(5);</span>
<span class="nc" id="L102">    }</span>

    @Test
    public void worksWithUnderestimatedCollections() {
<span class="nc" id="L106">        final List&lt;WeightedSample&gt; originalItems = weightedArray(new long[]{5, 1, 2, 3, 4}, new double[]{1, 2, 3, 2, 2});</span>
<span class="nc" id="L107">        final List&lt;WeightedSample&gt; spyItems = spy(originalItems);</span>
<span class="nc" id="L108">        doReturn(originalItems.toArray(new WeightedSample[]{})).when(spyItems).toArray(ArgumentMatchers.any(WeightedSample[].class));</span>
<span class="nc" id="L109">        when(spyItems.size()).thenReturn(4, 5);</span>

<span class="nc" id="L111">        final Snapshot other = new WeightedSnapshot(spyItems);</span>

<span class="nc" id="L113">        assertThat(other.getValues())</span>
<span class="nc" id="L114">                .containsOnly(1, 2, 3, 4, 5);</span>
<span class="nc" id="L115">    }</span>

    @Test
    public void worksWithOverestimatedCollections() {
<span class="nc" id="L119">        final List&lt;WeightedSample&gt; originalItems = weightedArray(new long[]{5, 1, 2, 3, 4}, new double[]{1, 2, 3, 2, 2});</span>
<span class="nc" id="L120">        final List&lt;WeightedSample&gt; spyItems = spy(originalItems);</span>
<span class="nc" id="L121">        doReturn(originalItems.toArray(new WeightedSample[]{})).when(spyItems).toArray(ArgumentMatchers.any(WeightedSample[].class));</span>
<span class="nc" id="L122">        when(spyItems.size()).thenReturn(6, 5);</span>

<span class="nc" id="L124">        final Snapshot other = new WeightedSnapshot(spyItems);</span>

<span class="nc" id="L126">        assertThat(other.getValues())</span>
<span class="nc" id="L127">                .containsOnly(1, 2, 3, 4, 5);</span>
<span class="nc" id="L128">    }</span>

    @Test
    public void dumpsToAStream() {
<span class="nc" id="L132">        final ByteArrayOutputStream output = new ByteArrayOutputStream();</span>

<span class="nc" id="L134">        snapshot.dump(output);</span>

<span class="nc" id="L136">        assertThat(output.toString())</span>
<span class="nc" id="L137">                .isEqualTo(String.format(&quot;1%n2%n3%n4%n5%n&quot;));</span>
<span class="nc" id="L138">    }</span>

    @Test
    public void calculatesTheMinimumValue() {
<span class="nc" id="L142">        assertThat(snapshot.getMin())</span>
<span class="nc" id="L143">                .isEqualTo(1);</span>
<span class="nc" id="L144">    }</span>

    @Test
    public void calculatesTheMaximumValue() {
<span class="nc" id="L148">        assertThat(snapshot.getMax())</span>
<span class="nc" id="L149">                .isEqualTo(5);</span>
<span class="nc" id="L150">    }</span>

    @Test
    public void calculatesTheMeanValue() {
<span class="nc" id="L154">        assertThat(snapshot.getMean())</span>
<span class="nc" id="L155">                .isEqualTo(2.7);</span>
<span class="nc" id="L156">    }</span>

    @Test
    public void calculatesTheStdDev() {
<span class="nc" id="L160">        assertThat(snapshot.getStdDev())</span>
<span class="nc" id="L161">                .isEqualTo(1.2688, offset(0.0001));</span>
<span class="nc" id="L162">    }</span>

    @Test
    public void calculatesAMinOfZeroForAnEmptySnapshot() {
<span class="nc" id="L166">        final Snapshot emptySnapshot = new WeightedSnapshot(</span>
<span class="nc" id="L167">                weightedArray(new long[]{}, new double[]{}));</span>

<span class="nc" id="L169">        assertThat(emptySnapshot.getMin())</span>
<span class="nc" id="L170">                .isZero();</span>
<span class="nc" id="L171">    }</span>

    @Test
    public void calculatesAMaxOfZeroForAnEmptySnapshot() {
<span class="nc" id="L175">        final Snapshot emptySnapshot = new WeightedSnapshot(</span>
<span class="nc" id="L176">                weightedArray(new long[]{}, new double[]{}));</span>

<span class="nc" id="L178">        assertThat(emptySnapshot.getMax())</span>
<span class="nc" id="L179">                .isZero();</span>
<span class="nc" id="L180">    }</span>

    @Test
    public void calculatesAMeanOfZeroForAnEmptySnapshot() {
<span class="nc" id="L184">        final Snapshot emptySnapshot = new WeightedSnapshot(</span>
<span class="nc" id="L185">                weightedArray(new long[]{}, new double[]{}));</span>

<span class="nc" id="L187">        assertThat(emptySnapshot.getMean())</span>
<span class="nc" id="L188">                .isZero();</span>
<span class="nc" id="L189">    }</span>

    @Test
    public void calculatesAStdDevOfZeroForAnEmptySnapshot() {
<span class="nc" id="L193">        final Snapshot emptySnapshot = new WeightedSnapshot(</span>
<span class="nc" id="L194">                weightedArray(new long[]{}, new double[]{}));</span>

<span class="nc" id="L196">        assertThat(emptySnapshot.getStdDev())</span>
<span class="nc" id="L197">                .isZero();</span>
<span class="nc" id="L198">    }</span>

    @Test
    public void calculatesAStdDevOfZeroForASingletonSnapshot() {
<span class="nc" id="L202">        final Snapshot singleItemSnapshot = new WeightedSnapshot(</span>
<span class="nc" id="L203">                weightedArray(new long[]{1}, new double[]{1.0}));</span>

<span class="nc" id="L205">        assertThat(singleItemSnapshot.getStdDev())</span>
<span class="nc" id="L206">                .isZero();</span>
<span class="nc" id="L207">    }</span>

    @Test
    public void expectNoOverflowForLowWeights() {
<span class="nc" id="L211">        final Snapshot scatteredSnapshot = new WeightedSnapshot(</span>
<span class="nc" id="L212">                weightedArray(</span>
                        new long[]{1, 2, 3},
                        new double[]{Double.MIN_VALUE, Double.MIN_VALUE, Double.MIN_VALUE}
                )
        );

<span class="nc" id="L218">        assertThat(scatteredSnapshot.getMean())</span>
<span class="nc" id="L219">                .isEqualTo(2);</span>
<span class="nc" id="L220">    }</span>

    @Test
    public void doesNotProduceNaNValues() {
<span class="nc" id="L224">        WeightedSnapshot weightedSnapshot = new WeightedSnapshot(</span>
<span class="nc" id="L225">                weightedArray(new long[]{1, 2, 3}, new double[]{0, 0, 0}));</span>
<span class="nc" id="L226">        assertThat(weightedSnapshot.getMean()).isEqualTo(0);</span>
<span class="nc" id="L227">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>